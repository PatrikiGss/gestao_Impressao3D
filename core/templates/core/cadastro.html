{% extends 'core/base.html' %}
{% load static %}
{% block title %}Cadastro - Impressora 3D{% endblock %}

{% block content %}
    <h1>Cadastro - Informações</h1>

    {% if form.non_field_errors %}
    <div class="error" style="color:red">{{ form.non_field_errors }}</div>
    {% endif %}

    {% if form.errors %}
    <div style="color:red">
        <ul>
        {% for field, errors in form.errors.items %}
            <li><strong>{{ field }}:</strong>
                <ul>
                {% for err in errors %}
                    <li>{{ err }}</li>
                {% endfor %}
                </ul>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="form-cadastro">
        {% csrf_token %}

        <label for="{{ form.nome.id_for_label }}">Nome:</label>
        {{ form.nome }}

        <label for="{{ form.curso.id_for_label }}">Curso:</label>
        {{ form.curso }}

        <label for="{{ form.quant_de_pecas.id_for_label }}">Quantidade de peças:</label>
        {{ form.quant_de_pecas }}

        <label for="{{ form.cor.id_for_label }}">Cor:</label>
        {{ form.cor }}

        <label for="{{ form.telefone.id_for_label }}">Telefone:</label>
        {{ form.telefone }}

        <label for="{{ form.arq_upload.id_for_label }}">Arquivo (.stl, .obj, .3mf, .gcode):</label>
        {{ form.arq_upload }}

        <label for="{{ form.arq_link.id_for_label }}">Link do arquivo (opcional):</label>
        {{ form.arq_link }}

        <p>Possui conhecimento técnico?</p>
        <label><input type="radio" name="conhecimento" value="nao" checked onclick="toggleCampos(false)"> Não</label>
        <label><input type="radio" name="conhecimento" value="sim" onclick="toggleCampos(true)"> Sim</label>

        <div id="campos-tecnicos" style="display:none; margin-top:10px;">
            <h3>Campos técnicos (opcionais)</h3>

            <label for="{{ form.tipo_preenchimento.id_for_label }}">Tipo de preenchimento:</label>
            {{ form.tipo_preenchimento }}

            <label for="{{ form.porcentagem_preenchimento.id_for_label }}">Porcentagem de preenchimento:</label>
            {{ form.porcentagem_preenchimento }}

            <label for="{{ form.resolucao.id_for_label }}">Resolução:</label>
            {{ form.resolucao }}

            <label for="{{ form.qual_impressora.id_for_label }}">Qual impressora:</label>
            {{ form.qual_impressora }}

            <label for="{{ form.tipo_filamento.id_for_label }}">Tipo de filamento:</label>
            {{ form.tipo_filamento }}
        </div>

        <button type="submit">Enviar</button>
    </form>

    <script>
    function toggleCampos(mostrar) {
        document.getElementById('campos-tecnicos').style.display = mostrar ? 'block' : 'none';
    }

    document.getElementById('form-cadastro').addEventListener('submit', function(e){
        const fileInput = document.querySelector('input[type="file"][name="arq_upload"]');
        if (fileInput && fileInput.files.length > 0) {
            const allowed = ['.stl', '.obj', '.3mf', '.gcode'];
            const name = fileInput.files[0].name.toLowerCase();
            const ext = name.substring(name.lastIndexOf('.'));
            if (!allowed.includes(ext)) {
                e.preventDefault();
                alert('Formato inválido! Envie um arquivo 3D (.stl, .obj, .3mf ou .gcode).');
                return false;
            }
        }
    });
    </script>
{% endblock %}
